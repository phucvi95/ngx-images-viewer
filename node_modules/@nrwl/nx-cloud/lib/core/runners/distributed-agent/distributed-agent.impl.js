const a6_0x29b4=['error','then','forEach','getTime','.lock','submitRunMetrics','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','writeFileSync','message','/tasks-hashes-','readFileSync','API\x20Response','unlinkSync','Other\x20Nx\x20Cloud\x20Agents\x20Detected','completed','catch','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','__esModule','../../error/print-run-group-error','true','existsSync','maxParallel','params','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','target','/lockfiles','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','configuration','DistributedAgentApi','execSync','readdirSync','floor','length','__awaiter','printRunGroupError','completedTasks','No\x20new\x20messages\x20received\x20after\x20','exit','projects','../../../utilities/metric-logger','map','options','VERBOSE_LOGGING','push','Duplicate\x20Agent\x20ID\x20Detected','./node_modules/.cache/nx','reset','Distributed\x20Execution\x20Terminated','/nx.json','CIRCLE_JOB','find','Critical\x20Error\x20in\x20Agent:\x20\x22','completeRunGroupWithError','projectName','Waiting...','Fetching\x20tasks...','criticalErrorMessage','apply','toString','Error:','NX_AGENT_NAME','NO_MESSAGES_TIMEOUT','../../../utilities/nx-imports','tasks','Waiter','child_process','../../../utilities/environment','\x20--projects=','Executing:\x20\x27','note','inherit','../../../utilities/waiter','join','cacheDirectory','next','retryDuring','value','parse','done','completedStatusCode','npx\x20nx\x20run-many\x20--target=','./distributed-agent.api','../../../utilities/create-unchanged-value-timeout','startAgent','completed:\x20','createUnchangedValueTimeout','RUN_GROUP_COMPLETED','status','wait','error:\x20','assign','\x20seconds','includes','getRunGroup','default','\x20--parallel\x20--max-parallel=','warn','strip-json-comments','number\x20of\x20tasks:\x20','executionId','mkdirSync','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','retryDuring:\x20','status:\x20','maxParallel:\x20','defineProperty','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','Agent\x20was\x20terminated\x20via\x20SIGTERM','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','CIRCLE_STAGE','SIGTERM','env'];(function(_0x447fc3,_0x29b4c2){const _0x4198d5=function(_0xf2e9c9){while(--_0xf2e9c9){_0x447fc3['push'](_0x447fc3['shift']());}};_0x4198d5(++_0x29b4c2);}(a6_0x29b4,0x184));const a6_0x4198=function(_0x447fc3,_0x29b4c2){_0x447fc3=_0x447fc3-0x0;let _0x4198d5=a6_0x29b4[_0x447fc3];return _0x4198d5;};'use strict';var __awaiter=this&&this[a6_0x4198('0x5d')]||function(_0x40a6c0,_0x5dd44d,_0x2e8967,_0x23480b){function _0x496a15(_0x4e9014){return _0x4e9014 instanceof _0x2e8967?_0x4e9014:new _0x2e8967(function(_0x4b07d0){_0x4b07d0(_0x4e9014);});}return new(_0x2e8967||(_0x2e8967=Promise))(function(_0xbdb28d,_0x34ba31){function _0x155d50(_0x56b52b){try{_0x598f5e(_0x23480b['next'](_0x56b52b));}catch(_0x5d653b){_0x34ba31(_0x5d653b);}}function _0x57c342(_0x1ff801){try{_0x598f5e(_0x23480b['throw'](_0x1ff801));}catch(_0x15e366){_0x34ba31(_0x15e366);}}function _0x598f5e(_0x630214){_0x630214[a6_0x4198('0x1a')]?_0xbdb28d(_0x630214[a6_0x4198('0x18')]):_0x496a15(_0x630214[a6_0x4198('0x18')])[a6_0x4198('0x3d')](_0x155d50,_0x57c342);}_0x598f5e((_0x23480b=_0x23480b[a6_0x4198('0x5')](_0x40a6c0,_0x5dd44d||[]))[a6_0x4198('0x16')]());});};Object[a6_0x4198('0x35')](exports,a6_0x4198('0x4d'),{'value':!![]});exports[a6_0x4198('0x1f')]=void 0x0;const child_process_1=require(a6_0x4198('0xd'));const fs_1=require('fs');const stripJsonComments=require(a6_0x4198('0x2d'));const create_unchanged_value_timeout_1=require(a6_0x4198('0x1e'));const environment_1=require(a6_0x4198('0xe'));const metric_logger_1=require(a6_0x4198('0x63'));const waiter_1=require(a6_0x4198('0x13'));const print_run_group_error_1=require(a6_0x4198('0x4e'));const distributed_agent_api_1=require(a6_0x4198('0x1d'));const {output,workspaceRoot}=require(a6_0x4198('0xa'));function executeTasks(_0x12b3a9,_0x588ae2){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x42394f=0x0;let _0x3cdeae=null;const _0x47af82=(0x0,create_unchanged_value_timeout_1[a6_0x4198('0x21')])({'title':a6_0x4198('0x60')+environment_1[a6_0x4198('0x9')]/0x3e8+a6_0x4198('0x27'),'timeout':environment_1[a6_0x4198('0x9')]});const _0x111852=new waiter_1[(a6_0x4198('0xc'))]();let _0x3fc515=[];const _0x1968a9=new Date();let _0x3361df=![];while(!![]){if(environment_1['VERBOSE_LOGGING']){output['note']({'title':a6_0x4198('0x3')});}_0x3cdeae=yield _0x588ae2[a6_0x4198('0xb')](_0x3cdeae?_0x3cdeae[a6_0x4198('0x2f')]:null,_0x42394f,_0x3fc515);if(environment_1[a6_0x4198('0x66')]){output[a6_0x4198('0x11')]({'title':a6_0x4198('0x47'),'bodyLines':[a6_0x4198('0x20')+_0x3cdeae['completed'],a6_0x4198('0x33')+_0x3cdeae[a6_0x4198('0x23')],a6_0x4198('0x32')+_0x3cdeae[a6_0x4198('0x17')],'executionId:\x20'+_0x3cdeae[a6_0x4198('0x2f')],a6_0x4198('0x2e')+_0x3cdeae[a6_0x4198('0xb')][a6_0x4198('0x5c')],a6_0x4198('0x25')+_0x3cdeae[a6_0x4198('0x4')],a6_0x4198('0x34')+_0x3cdeae[a6_0x4198('0x51')]]});}if(_0x3cdeae[a6_0x4198('0x4')]){output[a6_0x4198('0x3c')]({'title':a6_0x4198('0x6b'),'bodyLines':[a6_0x4198('0x7'),_0x3cdeae[a6_0x4198('0x4')]]});process[a6_0x4198('0x61')](0x0);}if((_0x3cdeae===null||_0x3cdeae===void 0x0?void 0x0:_0x3cdeae[a6_0x4198('0x17')])&&(_0x3cdeae===null||_0x3cdeae===void 0x0?void 0x0:_0x3cdeae['retryDuring'])!==0x0&&!_0x3361df&&new Date()['getTime']()-_0x1968a9[a6_0x4198('0x3f')]()>_0x3cdeae[a6_0x4198('0x17')]){yield _0x111852['wait']();continue;}if((_0x3cdeae===null||_0x3cdeae===void 0x0?void 0x0:_0x3cdeae[a6_0x4198('0x23')])!==undefined){if(_0x3cdeae['status']===a6_0x4198('0x22')||_0x3cdeae[a6_0x4198('0x23')]==='NO_FURTHER_TASKS_TO_RUN'){return;}}else if(_0x3cdeae[a6_0x4198('0x4a')]){return;}_0x47af82(_0x3cdeae[a6_0x4198('0xb')][a6_0x4198('0x64')](_0x304625=>_0x304625['taskId'])[a6_0x4198('0x14')](''));if(!_0x3cdeae[a6_0x4198('0x2f')]){if(environment_1['VERBOSE_LOGGING']){output['note']({'title':a6_0x4198('0x2')});}yield _0x111852[a6_0x4198('0x24')]();_0x42394f=0x0;_0x3fc515=[];continue;}_0x111852[a6_0x4198('0x6a')]();_0x3361df=!![];const _0x383398=invokeTasksUsingRunMany(_0x12b3a9,_0x3cdeae[a6_0x4198('0x2f')],_0x3cdeae['tasks'],_0x3cdeae[a6_0x4198('0x51')]);_0x42394f=_0x383398[a6_0x4198('0x1b')];_0x3fc515=_0x383398[a6_0x4198('0x5f')];}});}function readCompletedTasks(_0x14e28f,_0xdecb79){const _0x358c54=a6_0x4198('0x56')+_0xdecb79+').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.';let _0xd834b6;try{const _0x4a75f5=_0x14e28f[a6_0x4198('0x15')]||a6_0x4198('0x69');const _0x2dd8d0=_0x4a75f5+a6_0x4198('0x45')+_0xdecb79;_0xd834b6=JSON[a6_0x4198('0x19')]((0x0,fs_1[a6_0x4198('0x46')])(_0x2dd8d0)[a6_0x4198('0x6')]());(0x0,fs_1[a6_0x4198('0x48')])(_0x2dd8d0);}catch(_0x2b6a4f){throw new Error(_0x358c54);}if(_0xd834b6[a6_0x4198('0x5c')]==0x0){throw new Error(_0x358c54);}return _0xd834b6;}function invokeTasksUsingRunMany(_0x3ed701,_0xdca9e9,_0x34235a,_0x20f865){let _0xf2dd81=0x0;const _0x24620c=[];for(const _0x3b50db of groupByTarget(_0x34235a)){const _0x210dca=_0x3b50db[a6_0x4198('0x57')]?'--configuration='+_0x3b50db[a6_0x4198('0x57')]:'';const _0x36c326=_0x20f865>0x1?a6_0x4198('0x2b')+_0x20f865:'';const _0x5822f4=a6_0x4198('0x1c')+_0x3b50db['target']+'\x20'+_0x210dca+a6_0x4198('0xf')+_0x3b50db[a6_0x4198('0x62')][a6_0x4198('0x14')](',')+'\x20'+_0x3b50db[a6_0x4198('0x52')]+_0x36c326;if(environment_1[a6_0x4198('0x66')]){output[a6_0x4198('0x11')]({'title':a6_0x4198('0x10')+_0x5822f4+'\x27'});}try{(0x0,child_process_1[a6_0x4198('0x59')])(_0x5822f4,{'stdio':['ignore','inherit',a6_0x4198('0x12')],'env':Object[a6_0x4198('0x26')](Object[a6_0x4198('0x26')]({},process['env']),{'NX_CACHE_FAILURES':a6_0x4198('0x4f'),'NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0xdca9e9,'NX_STREAM_OUTPUT':'true','NX_PREFIX_OUTPUT':a6_0x4198('0x4f')})});_0x24620c['push'](...readCompletedTasks(_0x3ed701,_0xdca9e9));}catch(_0x9b9465){if(_0x9b9465[a6_0x4198('0x23')]===environment_1[a6_0x4198('0x38')]){throw _0x9b9465;}else{_0xf2dd81=0x1;_0x24620c['push'](...readCompletedTasks(_0x3ed701,_0xdca9e9));}}}return{'completedStatusCode':_0xf2dd81,'completedTasks':_0x24620c};}function groupByTarget(_0x385343){const _0x2af174=[];_0x385343[a6_0x4198('0x3e')](_0x593086=>{const _0x10be3e=_0x2af174[a6_0x4198('0x6e')](_0x551e22=>_0x551e22[a6_0x4198('0x54')]===_0x593086['target']&&_0x551e22[a6_0x4198('0x57')]===_0x593086['configuration']);if(_0x10be3e){_0x10be3e[a6_0x4198('0x62')]['push'](_0x593086[a6_0x4198('0x1')]);}else{_0x2af174[a6_0x4198('0x67')]({'target':_0x593086[a6_0x4198('0x54')],'projects':[_0x593086[a6_0x4198('0x1')]],'params':_0x593086[a6_0x4198('0x52')],'configuration':_0x593086['configuration']});}});return _0x2af174;}function getAgentName(){if(process[a6_0x4198('0x3b')][a6_0x4198('0x8')]!==undefined){return process[a6_0x4198('0x3b')][a6_0x4198('0x8')];}else if(process[a6_0x4198('0x3b')]['CIRCLECI']!==undefined&&process[a6_0x4198('0x3b')][a6_0x4198('0x39')]){return process[a6_0x4198('0x3b')][a6_0x4198('0x39')];}else if(process[a6_0x4198('0x3b')]['CIRCLECI']!==undefined&&process[a6_0x4198('0x3b')]['CIRCLE_JOB']){return process[a6_0x4198('0x3b')][a6_0x4198('0x6d')];}else{return'Agent\x20'+Math[a6_0x4198('0x5b')](Math['random']()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x572570,_0x3208f7,_0x22b682){const _0x3cff02=_0x3208f7[a6_0x4198('0x15')]||'./node_modules/.cache/nx';const _0x9de6c5=_0x3cff02+a6_0x4198('0x55');const _0x1f1fcd=_0x9de6c5+'/'+_0x22b682+a6_0x4198('0x40');if(!(0x0,fs_1[a6_0x4198('0x50')])(_0x9de6c5)){(0x0,fs_1[a6_0x4198('0x30')])(_0x9de6c5,{'recursive':!![]});}const _0x59ee77=(0x0,fs_1[a6_0x4198('0x5a')])(_0x9de6c5);if(_0x59ee77[a6_0x4198('0x5c')]){if(_0x59ee77[a6_0x4198('0x28')](_0x22b682+a6_0x4198('0x40'))){output[a6_0x4198('0x3c')]({'title':a6_0x4198('0x68'),'bodyLines':[a6_0x4198('0x53'),'','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.']});process[a6_0x4198('0x61')](0x1);}output[a6_0x4198('0x2c')]({'title':a6_0x4198('0x49'),'bodyLines':[a6_0x4198('0x4c'),'',a6_0x4198('0x42'),a6_0x4198('0x31')]});}(0x0,fs_1[a6_0x4198('0x43')])(_0x1f1fcd,'');process['on'](a6_0x4198('0x61'),_0x4dc6fa=>{cleanupAgentLockfile(_0x1f1fcd,_0x4dc6fa);});process['on'](a6_0x4198('0x3a'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x572570['completeRunGroupWithError'](a6_0x4198('0x37'));cleanupAgentLockfile(_0x1f1fcd,0x1);}));process['on']('SIGINT',()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x572570[a6_0x4198('0x0')]('Agent\x20was\x20terminated\x20via\x20SIGINT');cleanupAgentLockfile(_0x1f1fcd,0x1);}));}function cleanupAgentLockfile(_0x3caac4,_0x4ad1c7){if((0x0,fs_1[a6_0x4198('0x50')])(_0x3caac4)){(0x0,fs_1[a6_0x4198('0x48')])(_0x3caac4);process['exit'](_0x4ad1c7);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0xe29f77=(0x0,environment_1[a6_0x4198('0x29')])();if(!_0xe29f77){(0x0,print_run_group_error_1[a6_0x4198('0x5e')])();return process[a6_0x4198('0x61')](0x1);}output[a6_0x4198('0x11')]({'title':a6_0x4198('0x36')});const _0x3e0bd3=JSON[a6_0x4198('0x19')](stripJsonComments((0x0,fs_1[a6_0x4198('0x46')])(workspaceRoot+a6_0x4198('0x6c'))['toString']()))['tasksRunnerOptions'][a6_0x4198('0x2a')][a6_0x4198('0x65')];const _0x301e6a=getAgentName();const _0xa0c3da=new distributed_agent_api_1[(a6_0x4198('0x58'))](_0x3e0bd3,_0xe29f77,_0x301e6a);createAgentLockfileAndSetUpListeners(_0xa0c3da,_0x3e0bd3,_0x301e6a);return executeTasks(_0x3e0bd3,_0xa0c3da)[a6_0x4198('0x3d')](_0x271a6f=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x4198('0x41')])(_0x3e0bd3);return _0x271a6f;}))[a6_0x4198('0x4b')](_0x1712eb=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0xa0c3da[a6_0x4198('0x0')](a6_0x4198('0x6f')+_0x1712eb[a6_0x4198('0x44')]+'\x22');throw _0x1712eb;}));});}exports[a6_0x4198('0x1f')]=startAgent;